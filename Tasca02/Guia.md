# DPR: CÒPIES DE SEGURETAT. CAS PRÀCTIC

| Part 1: Còpia seguretat dels equips clients Windows |
|----------------------------------------|

Creem una màquina virtual Windows 11 amb dos discos, instal·lem el sistema operatiu i un de secundari de 10 GB que servirà per emmagatzemar les còpies de seguretat. Paràmetres, emmagatzematge i creem.

![Creem una màquina virtual Windows 11 amb dos discos, instal·lem el sistema operatiu i un de secundari de 10 GB que servirà per emmagatzemar les còpies de seguretat. Paràmetres, emmagatzematge i creem.](Img/Imatge01.png)

![Creem una màquina virtual Windows 11 amb dos discos, instal·lem el sistema operatiu i un de secundari de 10 GB que servirà per emmagatzemar les còpies de seguretat. Paràmetres, emmagatzematge i creem.](Img/Imatge02.png)

![Creem una màquina virtual Windows 11 amb dos discos, instal·lem el sistema operatiu i un de secundari de 10 GB que servirà per emmagatzemar les còpies de seguretat. Paràmetres, emmagatzematge i creem.](Img/Imatge03.png)

Ara anem a administrar espais d'emmagatzematge, després a crear grup d’emmagatzematge, creem el grup i creem l’espai d'emmagatzematge.

![Ara anem a administrar espais d'emmagatzematge, després a crear grup d’emmagatzematge, creem el grup i creem l’espai d'emmagatzematge.](Img/Imatge04.png)

![Ara anem a administrar espais d'emmagatzematge, després a crear grup d’emmagatzematge, creem el grup i creem l’espai d'emmagatzematge.](Img/Imatge05.png)

Ara anem a Google Drive, usant un compte que no és d’escola, per fer la simulació. 

![Ara anem a Google Drive, usant un compte que no és d’escola, per fer la simulació. ](Img/Imatge06.png)

Ara instal·lem Duplicati.

![Ara instal·lem Duplicati.](Img/Imatge07.png)

Seguidament creem les còpies de seguretat. 

![Seguidament creem les còpies de seguretat. ](Img/Imatge08.png)

![Seguidament creem les còpies de seguretat. ](Img/Imatge09.png)

Posem nom a la còpia de seguretat, descripció, contrasenya. 

![Posem nom a la còpia de seguretat, descripció, contrasenya. ](Img/Imatge10.png)

Cliquem l’opció de File system.

![Cliquem l’opció de File system.](Img/Imatge11.png)

Ara escollim el disc secundari.

![Ara escollim el disc secundari.](Img/Imatge12.png)

Després aquí escollim la carpeta que volem copiar. Home, on tenim documents, downloads…etc

![Després aquí escollim la carpeta volem copiar. Home, on tenim documents, downloads…etc](Img/Imatge14.png)

Ara aquí hem de posar quan farem les còpies de seguretat, en aquest cas posem que cada hora es repetiran les còpies de seguretat que aniran al disc secundari. Després continuem i ja per finalitzar en Options, deixem l'opció "Keep all backups” (Conserva totes les còpies), així cada còpia de seguretat es guardarà sense eliminar-ne cap i a baix a la dreta, cliquem Submit (Ens hem de registrar, perquè ens deixi fer el Submit per això, sense registre no deixa, i amb registre sí, cliquem a dalt a la dreta en Click to register). 


![Ara aquí hem de posar quan farem les còpies de seguretat, en aquest cas posem que cada hora es repetiran les còpies de seguretat que aniran al disc secundari. Després continuem i ja per finalitzar en Options, a baix a la dreta, cliquem Submit (Ens hem de registrar, perquè ens deixi fer el Submit per això, sense registre no deixa, i amb registre sí, cliquem a dalt a la dreta en Click to register). ](Img/Imatge15.png)

![Ara aquí hem de posar quan farem les còpies de seguretat, en aquest cas posem que cada hora es repetiran les còpies de seguretat que aniran al disc secundari. Després continuem i ja per finalitzar en Options, a baix a la dreta, cliquem Submit (Ens hem de registrar, perquè ens deixi fer el Submit per això, sense registre no deixa, i amb registre sí, cliquem a dalt a la dreta en Click to register). ](Img/Imatge16.png)

Creat, afegirem arxius a les carpetes de l’usuari, especialment a Documents, després farà les còpies corresponents en els horaris/moments corresponents al lloc (el funcionament).

![Creat, afegirem arxius a les carpetes de l’usuari, especialment a Documents, després farà les còpies corresponents en els horaris/moments corresponents al lloc (el funcionament).](Img/Imatge17.png)

Ara creem l'altre còpia de seguretat, pel Drive. Posem nom a la còpia de seguretat, descripció, contrasenya.

![Ara creem l'altre còpia de seguretat, pel Drive. Posem nom a la còpia de seguretat, descripció, contrasenya.](Img/Imatge18.png)

Cliquem l’opció de Drive.

![Cliquem l’opció de Drive.](Img/Imatge19.png)

Escollim la carpeta corresponent que volem copiar.

![Escollim la carpeta corresponent que volem copiar.](Img/Imatge20.png)

Ara aquí hem de posar quan farem les còpies de seguretat, en aquest cas posem que cada dia a las 18:00 es repetiran les còpies de seguretat que aniran al Drive. Després continuem i ja per finalitzar en Options, deixem l'opció "Keep all backups” (Conserva totes les còpies), així cada còpia de seguretat es guardarà sense eliminar-ne cap i a baix a la dreta, cliquem Submit.

![Ara aquí hem de posar quan farem les còpies de seguretat, en aquest cas posem que cada dia a las 18:00 es repetiran les còpies de seguretat que aniran al Drive. Després continuem i ja per finalitzar en Options, deixem l'opció "Keep all backups” (Conserva totes les còpies), així cada còpia de seguretat es guardarà sense eliminar-ne cap i a baix a la dreta, cliquem Submit.](Img/Imatge21.png)

![Ara aquí hem de posar quan farem les còpies de seguretat, en aquest cas posem que cada dia a las 18:00 es repetiran les còpies de seguretat que aniran al Drive. Després continuem i ja per finalitzar en Options, deixem l'opció "Keep all backups” (Conserva totes les còpies), així cada còpia de seguretat es guardarà sense eliminar-ne cap i a baix a la dreta, cliquem Submit.](Img/Imatge22.png)

Creat, afegirem arxius a les carpetes de l’usuari, especialment a Documents, després farà les còpies corresponents en els horaris/moments corresponents al lloc (el funcionament).

![Creat, afegirem arxius a les carpetes de l’usuari, especialment a Documents, després farà les còpies corresponents en els horaris/moments corresponents al lloc (el funcionament).](Img/Imatge23.png)

Fem AuthID a la còpia del Drive perquè funcioni el backup. Per això, en donar-li Start, per exemple, no fa la còpia de seguretat, surt una notificació d'error, on hi ha un enllaç, el copiem, el posem al navegador de Chrome i copiem el text que ens surt, el que surt a la següent imatge, anem a la còpia de seguretat de Drive i en Destination, AuthID el copiem i ja estaria.

![Fem AuthID a la còpia del Drive perquè funcioni el backup. Per això, en donar-li Start, per exemple, no fa la còpia de seguretat, surt una notificació d'error, on hi ha un enllaç, el copiem, el posem al navegador de Chrome i copiem el text que ens surt, el que surt a la següent imatge, anem a la còpia de seguretat de Drive i en Destination, AuthID el copiem i ja estaria.](Img/Imatge222.png)

![Fem AuthID a la còpia del Drive perquè funcioni el backup. Per això, en donar-li Start, per exemple, no fa la còpia de seguretat, surt una notificació d'error, on hi ha un enllaç, el copiem, el posem al navegador de Chrome i copiem el text que ens surt, el que surt a la següent imatge, anem a la còpia de seguretat de Drive i en Destination, AuthID el copiem i ja estaria.](Img/Imatge223.png)

Afegirem arxius a les carpetes de l’usuari, especialment a Documents, després farà les còpies corresponents en els horaris/moments corresponents al lloc (el funcionament).

![Afegirem arxius a les carpetes de l’usuari, especialment a Documents, després farà les còpies corresponents en els horaris/moments corresponents al lloc (el funcionament).](Img/Imatge244.png)

Ara que ja hi han còpies fetes (Versions), esborrem el contingut de Documents i procedim a fer una restauració des del disc secundari i comprovem com podem fer una restauració des de la còpia que teniu emmagatzemada al cloud.

![Ara que ja hi han còpies fetes (Versions), esborrem el contingut de Documents i procedim a fer una restauració des del disc secundari i comprovem com podem fer una restauració des de la còpia que teniu emmagatzemada al cloud.](Img/Imatge25.png)

![Ara que ja hi han còpies fetes (Versions), esborrem el contingut de Documents i procedim a fer una restauració des del disc secundari i comprovem com podem fer una restauració des de la còpia que teniu emmagatzemada al cloud.](Img/Imatge2555.png)

Restauració des del disc secundari. Anem a Restore i escollim l'opció de Còpia de seguretat (disc secundari) i cliquem en Restore. 

![Restauració des del disc secundari. Anem a Restore i escollim l'opció de Còpia de seguretat (disc secundari) i cliquem en Restore. ](Img/Imatge26.png)

Hem de seleccionar els fitxers, seleccionem i confirmem correctament, Continue. 

![Hem de seleccionar els fitxers, seleccionem i confirmem correctament, Continue. ](Img/Imatge27.png)

Original location i Overwrite (en aquest cas). I finalment Submit.

![Original location i Overwrite (en aquest cas). I finalment Submit.](Img/Imatge28.png)

![Original location i Overwrite (en aquest cas). I finalment Submit.](Img/Imatge29.png)

I la restauració estaria completada.

![I la restauració estaria completada.](Img/Imatge30.png)

I el contingut ja està correctament restaurat.

![I el contingut ja està correctament restaurat.](Img/Imatge31.png)

Comprovem com podem fer una restauració des de la còpia que teniu emmagatzemada al cloud. Fent el mateix procediment. Ara que ja hi han còpies fetes (Versions), esborrem el contingut de Documents i comprovem com podem fer una restauració des de la còpia que teniu emmagatzemada al cloud.

![Comprovem com podem fer una restauració des de la còpia que teniu emmagatzemada al cloud. Fent el mateix procediment. Ara que ja hi han còpies fetes (Versions), esborrem el contingut de Documents i comprovem com podem fer una restauració des de la còpia que teniu emmagatzemada al cloud.](Img/Imatge32.png)

![Comprovem com podem fer una restauració des de la còpia que teniu emmagatzemada al cloud. Fent el mateix procediment. Ara que ja hi han còpies fetes (Versions), esborrem el contingut de Documents i comprovem com podem fer una restauració des de la còpia que teniu emmagatzemada al cloud.](Img/Imatge3222.png)

Restauració des de la còpia que teniu emmagatzemada al cloud. Anem a Restore i escollim l'opció de Còpia de seguretat Drive i cliquem en Restore. 

![Restauració des de la còpia que teniu emmagatzemada al cloud. Anem a Restore i escollim l'opció de Còpia de seguretat Drive i cliquem en Restore. ](Img/Imatge33.png)

Hem de seleccionar els fitxers, seleccionem i confirmem correctament, Continue. 

![Hem de seleccionar els fitxers, seleccionem i confirmem correctament, Continue. ](Img/Imatge34.png)

Original location i Overwrite (en aquest cas). I finalment Submit.

![Original location i Overwrite (en aquest cas). I finalment Submit.](Img/Imatge35.png)

![Original location i Overwrite (en aquest cas). I finalment Submit.](Img/Imatge36.png)

I la restauració estaria completada.

![I la restauració estaria completada.](Img/Imatge37.png)

![I la restauració estaria completada.](Img/Imatge377.png)

Pot tenir horari diferent perquè la màquina canvia la hora tot el temps, sinó seria per el moment de creació de la carpeta i els arxius.

![I la restauració estaria completada. Pot tenir horari diferent perquè la màquina canvia la hora tot el temps, sinó seria per el moment de creació de la carpeta i els arxius.](Img/Imatge378.png)

Si ens fixem, tant al disc secundari com al nostre Google Drive surten els arxius Duplicati, són les còpies de seguretat encriptades que Duplicati ha creat. Entrem al nostre Google Drive per exemple i ho veiem.

![Si ens fixem, tant al disc secundari com al nostre Google Drive surten els arxius Duplicati, són les còpies de seguretat encriptades que Duplicati ha creat. Entrem al nostre Google Drive per exemple i ho veiem.](Img/Imatge38.png)

Disc secundari.

![Disc secundari.](Img/Imatge39.png)

| Part 2: Còpia seguretat servidor Linux |
|----------------------------------------|

Faig servir una màquina virtual amb un Ubuntu Server instal·lat i li hauré d'afegir un segon disc de 10 GB que simularà una unitat auxiliar.

![Faig servir una màquina virtual amb un Ubuntu Server instal·lat i li hauré d'afegir un segon disc de 10 GB que simularà una unitat auxiliar.](Img/Imatge40.png)

![Faig servir una màquina virtual amb un Ubuntu Server instal·lat i li afegiràs un segon disc de 10 GB que simularà una unitat auxiliar.](Img/Imatge41.png)

![Faig servir una màquina virtual amb un Ubuntu Server instal·lat i li afegiràs un segon disc de 10 GB que simularà una unitat auxiliar.](Img/Imatge42.png)

Inicialitzo i formatego en format xfs. Com simula una unitat externa, es muntarà manualment a /media/backup (primer cal crear la carpeta).

```
sudo mkdir /media/backup
```

```
ls -l /media/
```

![Inicialitzo i formatego en format xfs. Com simula una unitat externa, es muntarà manualment a /media/backup (primer cal crear la carpeta).](Img/Imatge43.png)

Ara després instal·lem fdisk, per donar format al disk.

```
sudo apt install fdisk
```

```
sudo fdisk -l
```

![Ara després instal·lem fdisk, per donar format al disk.](Img/Imatge44.png)

![Ara després instal·lem fdisk, per donar format al disk.](Img/Imatge45.png)

Ara instal·lem lvm2.

```
sudo apt install lvm2
```

![Ara instal·lem lvm2.](Img/Imatge46.png)

Creem volum al disk.

```
sudo pvcreate /dev/sdb
```

![Creem volum al disk.](Img/Imatge47.png)

Formategem. 

```
sudo mkfs.xfs -f /dev/sdb
```

![Formategem. ](Img/Imatge48.png)

Després muntem el disc a la carpeta /media/backup.

```
sudo mount /dev/sdb /media/backup
```

![Després muntem el disc a la carpeta /media/backup.](Img/Imatge49.png)

Instal·lem Duplicity. 

```
sudo apt install duplicity -y
```

![Instal·lem Duplicity. ](Img/Imatge50.png)

![Instal·lem Duplicity. ](Img/Imatge51.png)

Creem un parell d’usuaris més al sistema de manera que tinguin carpeta personal i creem 4 arxius de 10 MB a la carpeta home del nostre usuari.

```
sudo useradd -m -s /bin/bash usuari01
```

```
sudo useradd -m -s /bin/bash usuari02
```

```
sudo fallocate -l 10MB arx01
```

```
sudo fallocate -l 10MB arx02
```

```
sudo fallocate -l 10MB arx03
```

```
sudo fallocate -l 10MB arx04
```

![Creem un parell d’usuaris més al sistema de manera que tinguin carpeta personal i creem 4 arxius de 10 MB a la carpeta home del nostre usuari.](Img/Imatge52.png)

![Creem un parell d’usuaris més al sistema de manera que tinguin carpeta personal i creem 4 arxius de 10 MB a la carpeta home del nostre usuari.](Img/Imatge53.png)

![Creem un parell d’usuaris més al sistema de manera que tinguin carpeta personal i creem 4 arxius de 10 MB a la carpeta home del nostre usuari.](Img/Imatge54.png)

Ara fem una còpia de seguretat de la carpeta /home.

```
sudo duplicity full /home file:///media/backup/
```

```
ls /media/backup/
```

![Ara fem una còpia de seguretat de la carpeta /home.](Img/Imatge55.png)

![Ara fem una còpia de seguretat de la carpeta /home.](Img/Imatge56.png)

Esborrem els arxius i fem un restore per comprovar com es recuperen els arxius.

```
sudo rm arx01
```

```
sudo rm arx02
```

```
sudo rm arx03
```

```
sudo rm arx04
```

```
ls
```

```
sudo duplicity restore --force file:///media/backup/ /home
```

```
ls
```

![Esborrem els arxius i fem un restore per comprovar com es recuperen els arxius.](Img/Imatge57.png)

![Esborrem els arxius i fem un restore per comprovar com es recuperen els arxius.](Img/Imatge58.png)

![Esborrem els arxius i fem un restore per comprovar com es recuperen els arxius.](Img/Imatge59.png)

![Esborrem els arxius i fem un restore per comprovar com es recuperen els arxius.](Img/Imatge60.png)

Afegim un nou arxiu de 4 MB i fem una nova còpia. Observem com ara ha fet una còpia incremental.

```
fallocate -l 4MB arx05
```

```
sudo duplicity /home file:///media/backup/
```

![Afegim un nou arxiu de 4 MB i fem una nova còpia. Observem com ara ha fet una còpia incremental.](Img/Imatge61.png)

![Afegim un nou arxiu de 4 MB i fem una nova còpia. Observem com ara ha fet una còpia incremental.](Img/Imatge62.png)

Desmuntem la unitat de backup.

```
umount /media/backup
```

![Desmuntem la unitat de backup.](Img/Imatge63.png)

Ara passaràs a automatitzar el procés de les còpies utilitzant uns scripts bàsics i el programador de tasques (cron). Un aspecte molt important a nivell de seguretat, és que la unitat de backup ha d’estar per defecte, desmuntada. De manera que el primer pas sempre serà muntar la unitat i el darrer desmuntar-la, un cop s’ha fet la còpia.

Crea un script anomenat fullbackup.sh que realitzi la còpia completa de la carpeta /home i l’emmagatzemi al volum muntat. Usa la variable d’entorn PASSPHRASE (per donar valor a una variable d’entorn cal afegir a l’script una línia amb export PASSPHRASE=contrasenya) per no haver d’escriure la passphrase en el moment de l’execució. Recorda de donar permisos d’execució a l’script.

Creem l'arxiu, entrem i creem l'script.

```
sudo mkdir fullbackup.sh
```

```
sudo nano /fullbackup.sh
```

```
!/bin/bash
export PASSPHRASE="usuariusuari1234"
mount /dev/sdb /media/backup
duplicity full /home file:///media/backup/homebackup
umount /media/backup
```

![Ara passaràs a automatitzar el procés de les còpies utilitzant uns scripts bàsics i el programador de tasques (cron). Un aspecte molt important a nivell de seguretat, és que la unitat de backup ha d’estar per defecte, desmuntada. De manera que el primer pas sempre serà muntar la unitat i el darrer desmuntar-la, un cop s’ha fet la còpia.
Crea un script anomenat fullbackup.sh que realitzi la còpia completa de la carpeta /home i l’emmagatzemi al volum muntat. Usa la variable d’entorn PASSPHRASE (per donar valor a una variable d’entorn cal afegir a l’script una línia amb export PASSPHRASE=contrasenya) per no haver d’escriure la passphrase en el moment de l’execució. Recorda de donar permisos d’execució a l’script.
Creem l'arxiu, entrem i creem l'script.](Img/Imatge64.png)

![Ara passaràs a automatitzar el procés de les còpies utilitzant uns scripts bàsics i el programador de tasques (cron). Un aspecte molt important a nivell de seguretat, és que la unitat de backup ha d’estar per defecte, desmuntada. De manera que el primer pas sempre serà muntar la unitat i el darrer desmuntar-la, un cop s’ha fet la còpia.
Crea un script anomenat fullbackup.sh que realitzi la còpia completa de la carpeta /home i l’emmagatzemi al volum muntat. Usa la variable d’entorn PASSPHRASE (per donar valor a una variable d’entorn cal afegir a l’script una línia amb export PASSPHRASE=contrasenya) per no haver d’escriure la passphrase en el moment de l’execució. Recorda de donar permisos d’execució a l’script.
Creem l'arxiu, entrem i creem l'script.](Img/Imatge65.png)

![Ara passaràs a automatitzar el procés de les còpies utilitzant uns scripts bàsics i el programador de tasques (cron). Un aspecte molt important a nivell de seguretat, és que la unitat de backup ha d’estar per defecte, desmuntada. De manera que el primer pas sempre serà muntar la unitat i el darrer desmuntar-la, un cop s’ha fet la còpia.
Crea un script anomenat fullbackup.sh que realitzi la còpia completa de la carpeta /home i l’emmagatzemi al volum muntat. Usa la variable d’entorn PASSPHRASE (per donar valor a una variable d’entorn cal afegir a l’script una línia amb export PASSPHRASE=contrasenya) per no haver d’escriure la passphrase en el moment de l’execució. Recorda de donar permisos d’execució a l’script.
Creem l'arxiu, entrem i creem l'script.](Img/Imatge66.png)

Canviem els permisos, posem la següent comanda per canviar els permisos de manera que pugui executar.

```
sudo chmod +x fullbackup.sh
```

![Canviem els permisos, posem la següent comanda per canviar els permisos de manera que pugui executar.](Img/Imatge67.png)

Programem al cron com a root l’execució de l’script els diumenges a les 23:00.

```
crontab -e
```

![Programem al cron com a root l’execució de l’script els diumenges a les 23:00.](Img/Imatge68.png)

Posem aquest text:

```
0 23 * * 0 /home/usuari/fullbackup.sh
```

![Posem aquest text:](Img/Imatge69.png)

Creem un segon script anomenat incrementalbackup.sh que realitzi còpies incrementals de la mateixa carpeta que abans. Hem de fixar el valor de la variable PASSPHRASE igual que al punt 5 i donar permisos d’execució a l’script.

Creem l'arxiu, entrem i creem l'script.

```
sudo mkdir incrementalbackup.sh
```

```
sudo nano /incrementalbackup.sh
```

```
!/bin/bash
export PASSPHRASE="usuariusuari1234"
mount /dev/sdb /media/backup
duplicity incremental /home file:///media/backup/homebackup
umount /media/backup
```

![Creem un segon script anomenat incrementalbackup.sh que realitzi còpies incrementals de la mateixa carpeta que abans. Hem de fixar el valor de la variable PASSPHRASE igual que al punt 5 i donar permisos d’execució a l’script.
Creem l'arxiu, entrem i creem l'script.](Img/Imatge70.png)

![Creem un segon script anomenat incrementalbackup.sh que realitzi còpies incrementals de la mateixa carpeta que abans. Hem de fixar el valor de la variable PASSPHRASE igual que al punt 5 i donar permisos d’execució a l’script.
Creem l'arxiu, entrem i creem l'script.](Img/Imatge71.png)

Canviem els permisos, posem la següent comanda per canviar els permisos de manera que pugui executar.

```
sudo chmod +x incrementalbackup.sh 
```

![Canviem els permisos, posem la següent comanda per canviar els permisos de manera que pugui executar.](Img/Imatge72.png)

Programem al cron com a root l’execució de l’script a les 23:00 dels dilluns als diumenges.

```
crontab -e
```

![Programem al cron com a root l’execució de l’script a les 23:00 dels dilluns als diumenges.](Img/Imatge73.png)

Posem aquest text:

```
0 23 * * 0 /home/usuari/fullbackup.sh
0 23 * * 1-6 /home/usuari/incremental.sh
```

![Posem aquest text:](Img/Imatge74.png)

Desem canvis.

![Desem canvis.](Img/Imatge75.png)


[Anar a l'enunciat](../Tasca02/README.md)  
[Anar a la pàgina inicial](../README.md)
